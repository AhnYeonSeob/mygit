<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %> 
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn"%>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="security"%>



<style>

h2 {
    position: relative;
    display: inline-block;
    margin-bottom: 20px; /* 밑줄과 본문 간격 */
}

h2::after {
    content: '';
    position: absolute;
    left: 0;
    bottom: -5px; /* 글자 바로 아래에 위치 */
    width: 100%; /* 제목 텍스트의 너비에 맞춤 */
    height: 2px; /* 밑줄 두께 */
    background-color: #007bff; /* 은은한 파란색 */
    opacity: 0.5; /* 은은한 효과 */
}

* 테이블 스타일 */
.table {
    margin-top: 20px;
    background-color: white;
    border: 1px solid #ddd;
}

.table th {
    background-color: #f8f9fa;
    text-align: center;
    vertical-align: middle;
}

.table tbody tr:hover {
    background-color: #f1f1f1;
}

/* 버튼 스타일 */
.task-controls .btn {
    margin-left: 5px;
}

.task-controls .btn-primary:hover {
    background-color: #0056b3;
}

.task-controls .btn-danger:hover {
    background-color: #c82333;
}

/* 체크박스 스타일 */
#selectAll {
    cursor: pointer;
}

.task-select {
    cursor: pointer;
}

/* 수정 폼 영역 */
#form-area {
    margin-top: 20px;
    display: none;
}

#form-area.active {
    display: block;
}


</style>


<link rel="stylesheet" href="${pageContext.request.contextPath }/resources/js/ckeditor5/ckeditor5.css">
<script type="importmap">
		{
			"imports": {
							"ckeditor5": "${pageContext.request.contextPath }resources/js/ckeditor5/ckeditor5.js",
							"ckeditor5/": "${pageContext.request.contextPath }/resources/js/ckeditor5/translations/ko.js/"
			}
		}
</script>

<h2>프로젝트 관리</h2>
<div class="project-container">
    <div class="menu-bar">
    	<!-- 상단 메뉴 -->
		<nav class="py-2 bg-light border-bottom">
		    <div class="container d-flex flex-wrap">
	            <ul class="nav me-auto">
	                <li class="nav-item">
	                    <a class="nav-link link-dark px-3 fw-bold fs-5 active" href="${pageContext.request.contextPath }/lecture/${lectNo}/projectTask">과제관리</a>
	                </li>
                <security:authorize access="hasRole('PROFESSOR')"> 
	                <li class="nav-item">
	                    <a class="nav-link link-dark px-3 fs-5 active" href="${pageContext.request.contextPath }/lecture/${lectNo}/projectTaskSubmission">제출관리</a>
	                </li>
	                <li class="nav-item">
	                    <a class="nav-link link-dark px-3 fs-5 active" href="${pageContext.request.contextPath }/lecture/${lectNo}/projectTeam">팀관리</a>
	                </li>
	                <li class="nav-item">
	                    <a class="nav-link link-dark px-3 fs-5 active" href="${pageContext.request.contextPath }/lecture/${lectNo}/projectMember">팀원관리</a>
	                </li>
                </security:authorize>
	            </ul>
	            
	            <security:authorize access="hasRole('PROFESSOR')">
	            <ul class="nav">
		       		<li><span class="total-students">총 수강생: <span id="attendeeCount">${attendeeCount }명</span></span></li>
		    	</ul>
		    	</security:authorize>
		    	
		    </div>
		</nav>
    </div>
    
    <!-- 과제 테이블 -->
    <div id="projectControl" class="task-table-wrapper" data-path="${pageContext.request.contextPath }" data-lectno="${lectNo }">
        
        <security:authorize access="hasRole('PROFESSOR')">
        <div class="task-controls text-end my-3">
            <a href="${pageContext.request.contextPath }/lecture/${lectNo}/projectTask/new" class="btn btn-primary">등록</a>
            <button class="btn btn-info" id="editTaskBtn">수정</button>
            <button class="btn btn-danger" id="deleteTaskBtn">삭제</button>
        </div>
        </security:authorize>
        
        <table class="table table-bordered task-table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th>과제주제</th>
                    <th>과제제출마감일</th>
                    <th>배점</th>
                    <th>첨부파일</th>
                </tr>
            </thead>
            <tbody>
                <c:if test="${not empty projectTaskList }">
                    <c:forEach items="${projectTaskList }" var="task">
                        <tr id="task-row-${task.taskNo}">
						    <td class="text-center"><input type="checkbox" class="task-select" value="${task.taskNo}"></td>
						    <td class="task-title">
						    <a href="javascript:;" class="view-task-details" data-task-id="${task.taskNo}">
						        ${task.taskTitle}
						    </a>
						    </td>
						    <td class="text-center task-et">${fn:substring(task.taskEt, 0, 4)}-${fn:substring(task.taskEt, 4, 6)}-${fn:substring(task.taskEt, 6, 8)}</td>
						    <td class="text-center task-score">${task.taskScore}</td>
						    <td class="task-files" data-atch="${task.atchFileId }">
						        <c:choose>
						            <c:when test="${not empty task.atchFileId}">
						                <c:forEach items="${task.atchFile.fileDetails}" var="fd" varStatus="vs">
						                    <c:url value='/atch/${fd.atchFileId}/${fd.fileSn}' var="downUrl"/>
						                    <a href="${downUrl}">${fd.orignlFileNm}(${fd.fileFancysize})</a>
						                    ${not vs.last ? '|' : ''}
						                </c:forEach>
						            </c:when>
						            <c:otherwise>없음</c:otherwise>
						        </c:choose>
						    </td>
						</tr>
						<div id="form-area">
						</div>
                    </c:forEach>
                </c:if>
                <c:if test="${empty projectTaskList }">
                    <tr>
                        <td colspan="5" class="text-center">등록된 과제가 없습니다.</td>
                    </tr>
                </c:if>
            </tbody>
        </table>
    </div>

</div>

<div class="modal fade" id="taskDetailsModal" tabindex="-1" aria-labelledby="taskDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskDetailsModalLabel">과제 상세 정보</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 과제 상세 정보가 이곳에 동적으로 채워질 예정 -->
                <div id="taskDetailsContent">
                    <p>로딩 중...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>



<script src="${pageContext.request.contextPath }/resources/js/projectTask/projectTaskList.js" type="module"></script>