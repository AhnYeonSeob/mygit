/**
 * 
 */
const url = "../yguniv/dissent"
const upBtn = document.getElementById("upBtn")
const selDiv = document.getElementById("selDiv");

	const dataElement = document.getElementById('contextData');
	const contextPath = dataElement.dataset.contextPath;
function dissentPagg(page) {
	console.log(page);
	searchForm.page.value = page;
	searchForm.requestSubmit();
}

document.addEventListener("DOMContentLoaded", () => {

})
function calculateTotalScore(lesVo, scores) {
    let totalScore = 0;
    lesVo.forEach(item => {
        let score = 0;
        switch (item.evlStdrCd) {
            case "ASS":
                score = scores.assigScore;
                break;
            case "ATT":
                score = scores.attenAtndScore;
                break;
            case "ETC":
                score = scores.etcScore;
                break;
            case "FIN":
                score = scores.ftTestScore;
                break;
            case "MID":
                score = scores.prTestScore;
                break;
            default:
                console.error("Unknown evaluation standard code:", item.evlStdrCd);
                return;
        }
        totalScore += score * (item.rate / 100);
    });
    return Math.round(totalScore * 10) / 10; // 소수점 첫째자리까지 반올림
}
// 4.5 점수 기준으로 성적 변환 함수 (기존 점수를 4.5로 변환)
function convertToGrade(score) {
    // 점수를 4.5 기준으로 변환
    const scoreOn4_5Scale = (score / 100) * 4.5;
    
    let grade = '';
    if (scoreOn4_5Scale >= 4.3) {
        grade = 'A+';
    } else if (scoreOn4_5Scale >= 4.0) {
        grade = 'A';
    } else if (scoreOn4_5Scale >= 3.7) {
        grade = 'B+';
    } else if (scoreOn4_5Scale >= 3.3) {
        grade = 'B';
    } else if (scoreOn4_5Scale >= 3.0) {
        grade = 'C+';
    } else if (scoreOn4_5Scale >= 2.7) {
        grade = 'C';
    } else if (scoreOn4_5Scale >= 2.3) {
        grade = 'D+';
    } else if (scoreOn4_5Scale >= 2.0) {
        grade = 'D';
    } else {
        grade = 'F';
    }

    return grade;
}
//1인 조회용도
async function findOne(stu, lec) {
    const testDiv = document.getElementById("testDiv");
    const findUrl = `${contextPath}/dissent/${stu}/${lec}`;

    console.log(findUrl);
    var resp = await fetch(findUrl);
    var pars = await resp.json();
    console.log(pars);
    var data = await pars.dissOne;
    console.log(data);
    var lesData = await data.lectVO.lesVo;
    console.log(lesData);

    const totalScore = calculateTotalScore(data.lectVO.lesVo, data.attenVO);
/**
   const grade = totalScore >= 90 ? 'A' :
                  totalScore >= 80 ? 'B' :
                  totalScore >= 70 ? 'C' :
                  totalScore >= 60 ? 'D' : 'F';
 */ 

 const grade = convertToGrade(totalScore);
    let code = `
    <table class="table table-bordered">
            <tr>
                <th>강의번호</th>
                <th>강의명</th>
                <th>학번</th>
                <th>이름</th>
                <th>학점</th>
                <th>출석</th>
                <th>과제</th>
                <th>중간고사</th>
                <th>기말고사</th>
                <th>기타</th>
                <th>총점</th>
                <th>성적</th>
            </tr>		
            <tr>
                <input type='hidden' name='lectNo' id='lectNo' value='${data.lectNo}'></input>
                <input type='hidden' name='stuId' id='stuId' value='${data.attenVO.stuId}'></input>
                
                <td>${data.lectNo}</td>
                <td>${data.lectVO.lectNm}</td>
                <td>${data.attenVO.stuId}</td>
                <td>${data.nm}</td>
                <td>${data.lectVO.lectScore}</td>
                <td><input type='hidden' name='attenVO.attenAtndScore' id='attenAtndScore' value='${data.attenVO.attenAtndScore}'>${data.attenVO.attenAtndScore}</td>
                <td><input type='number' name='attenVO.assigScore' id='assigScore' value='${data.attenVO.assigScore}'></input></td>
                <td><input type='number' name='attenVO.prTestScore' id='prTestScore' value='${data.attenVO.prTestScore}'></input></td>
                <td><input type='number' name='attenVO.ftTestScore' id='ftTestScore' value='${data.attenVO.ftTestScore}'></input></td>
                <td><input type='number' name='attenVO.etcScore' id='etcScore' value='${data.attenVO.etcScore}'></input></td>
                <td>${totalScore}</td>
                <td>${grade}</td>
            </tr>	
            <tr>
                <th colspan='12'>이의 내용</th>
            </tr>	
            <tr>
                <td colspan='12'>${data.objcCn}</td>				
            </tr>	
            <tr>
                <th colspan='12'>답변 작성</th>
            </tr>	
            <tr>
                <td colspan='12'><textarea id='answerCn' name='answerCn'></textarea></td>				
            </tr>
            <tr>
            <td colspan='12'>
                <button type="button" onclick="updateForm();" id="upBtn"> 수정하기 </button>
                <button type="button" id="delBtn" onclick="deleteUp()"> 삭제하기 </button>
            </td>
            </tr>
    </table>
    `;

    selDiv.innerHTML = code;
    console.log(document.getElementById("selForm")); // 확인용
}

//선택창 비우기
function selDivClean() {
	const selDiv = document.querySelector("#selDiv")
	selDiv.replaceChildren();
}
async function updateForm() {
    const formd = document.getElementById("selForm");
    const formData = new FormData(formd);
    const jsonData = {};

    formData.forEach((value, key) => {
        if (key.startsWith("attenVO.")) {
            const attenKey = key.replace("attenVO.", "");
            if (!jsonData.attenVO) jsonData.attenVO = {};
            jsonData.attenVO[attenKey] = value;
        } else {
            jsonData[key] = value;
        }
    });

    try {
        const upResp = await fetch(`${contextPath}/dissent`, {
            method: "put",
            headers: { "Content-type": "application/json" },
            body: JSON.stringify(jsonData),
        });

        const da = await upResp.json();
        if (upResp.ok) {
            swal("수정 완료", "이의신청 내용이 성공적으로 수정되었습니다.", "success").then(() => {
                getDissentList(); // 테이블 업데이트
            });
        } else {
            swal("수정 실패", da.message || "이의신청 수정 중 오류가 발생했습니다.", "error");
        }
    } catch (error) {
        console.error("Error:", error);
        swal("오류 발생", "네트워크 오류 또는 서버 오류가 발생했습니다.", "error");
    }
}



async function getDissentList() {

	const getDissentListUrl = `${contextPath}/dissent/profe/new/dissent/list`
	var selDiv = document.querySelector("#selDiv")
	//	var dissentList = await fetch(getDissentListUrl)

	//console.log(dissentList)
	const response = await fetch(getDissentListUrl);
	const dissentList = await response.json(); // JSON 형태로 변환
	console.log(dissentList);
	//여기서 예시 함수 불러서 해보기
	// 테이블 내용 초기화
	const tbody = document.getElementById("tp");
	tbody.innerHTML = ""; // 기존 테이블 비우기

	// 새 데이터로 테이블 채우기
	const rows = dissentList.map(diss => `
    <tr>
        <td>${diss.lectVO.lectNo}</td>
        <td>${diss.lectVO.lectNm}</td>
        <td>${diss.personVO.id}</td>
        <td>${diss.personVO.nm}</td>
        <td>
            <button onclick="findOne('${diss.personVO.id}', '${diss.lectVO.lectNo}')">조회</button>
        </td>
    </tr>
`).join("");

tbody.innerHTML = rows;

	cl = `	
			 <table class="table table-bordered">
            <tr>
                <th>강의번호</th>
                <th>강의명</th>
                <th>학번</th>
                <th>이름</th>
                <th>학점</th>
                <th>출석</th>
                <th>과제</th>
                <th>중간고사</th>
                <th>기말고사</th>
                <th>기타</th>
                <th>총점</th>
                <th>성적</th>
            </tr>		
            <tr>
               
                <td>미선택</td>
                <td>미등록</td>
                <td>미등록</td>
                <td>미등록</td>
                <td>미등록</td>
                <td>미등록</td>
                <td>미등록</td>
                <td>미등록</td>
                <td>미등록</td>
                <td>미등록</td>
                <td>미등록</td>
                <td>미등록</td>
            </tr>	
            <tr>
                <th colspan='12'>이의 내용</th>
            </tr>	
            <tr>
                <td colspan='12'></td>				
            </tr>	
            <tr>
                <th colspan='12'>답변 작성</th>
            </tr>	
            <tr>
                <td colspan='12'><textarea id='answerCn' name='answerCn'></textarea></td>				
            </tr>
            <tr>
            <td colspan='12'>
                <button type="button" onclick="updateForm();" id="upBtn"> 수정하기 </button>
                <button type="button" id="delBtn" onclick="deleteUp()"> 삭제하기 </button>
            </td>
            </tr>
    </table>
    `;
	selDiv.innerHTML = cl;
}




/**
document.addEventListener("DOMContentLoaded", () => {
  

	selDiv.addEventListener("submit", async (e) => {
		if (e.target.id === "scoreForm") {
			console.log("폼 제출 이벤트 발생");
		    
			e.preventDefault();
			console.log(e.target);
			const formData = new FormData(e.target);
			const jsonData = {};
			formData.forEach((value, key) => {
				console.log(key, value);
				jsonData[key] = value;
			});

			console.log("JSON 데이터:", jsonData);

			// 여기에 서버로 데이터를 전송하는 로직 추가 가능
			// 예: await fetch('/your-api-url', { method: 'POST', body: JSON.stringify(jsonData), headers: { 'Content-Type': 'application/json' } });
		}
	});
});

 */


// 여부 타입에 대하여 N을 자동으로 기입 함수 	설정이 실패 했을 때 디폴트 값이 0이 되는 함수

async function makeTag(parseData, parentTag) {
	let code = '<table class="table table-bordered">';
	for (let key in parseData) {
		if (typeof parseData[key] === 'object' && parseData[key] !== null) {
			code += `<tr><td>${key} : <input type='text' class='bind-target' id='${key}' name='${key}' value='Object'></input></td></tr>`;
			code += await makeTag(parseData[key], parentTag);
		} else {
			let value = parseData[key] ? parseData[key] : '비어있음';
			code += `<tr><td>${key} : <input type='text' class='bind-target' id='${key}' name='${key}' value='${value}'></input></td></tr>`;
		}
	}
	code += '</table>';

	console.log(code);
	return code;
}
async function makeProperty(parseData, parentTag) {
	let code = '';
	for (let key in parseData) {
		if (typeof parseData[key] === 'object' && parseData[key] !== null) {
			code += `<tr><td>${key} : <input type='text' class='bind-target' id='${key}' name='${key}' value='Object'></input></td></tr>`;
			code += await makeTag(parseData[key], parentTag);
		} else {
			let value = parseData[key] ? parseData[key] : '비어있음';
			code += `<tr><td>${key} : <input type='text' class='bind-target' id='${key}' name='${key}' value='${value}'></input></td></tr>`;
		}
	}
	code += '</table>';

	console.log(code);
	return code;
}



document.addEventListener("DOMContentLoaded", async () => {
	const getDummyUrl = `${contextPath}/dissent/profe/new/dissent/list` //요청 url
	const $dummyTable = $("#parentTable"); // table
	//await dataTableFunction(getDummyUrl, $dummyTable); //데이터 테이블은 jquery객체를 넘겨야함
})

// null 값을 제거하는 재귀 함수
function removeNullProperties(obj) {
	if (typeof obj !== 'object' || obj === null) {
		return obj; // 객체가 아니거나 null인 경우 그대로 반환
	}

	// 객체를 복제하면서 null이 아닌 값만 유지
	if (Array.isArray(obj)) {
		return obj.map(item => removeNullProperties(item)).filter(item => item !== null);
	}

	const result = {};
	for (const key in obj) {
		if (obj[key] !== null) {
			result[key] = removeNullProperties(obj[key]);
		}
	}
	return result;
}


/**

async function dataTableFunction(sendUrl, parentTable) {

	$.ajax({
		url: sendUrl,
		type: "GET",
		success: function(data) {
			//	console.log(data) 전체 데이터
			//	console.log(data[0].lectVO.lectNo) 리스트=> 배열로 반환
			parentTable.dataTable({
				data: data,
				columns: [ 		//VO가 has 관계를 지녀 그 안의 데이터를 가져올 경우에는 . 닷노테이션 접근
					{
						data: 'lectVO.lectNo', title: '강의번호', //조건마다 다른 형태를 표시해야하면 render:function if(T?F?){return <tag>} else{return <tag>}
						render: function(data, type, row) {
							if (row.lectVO.lectNo == 'L003') { 
								return `<button class="btn btn-primary" >${row.lectVO.lectNo}</button>`;
							} else { return `<button class="btn btn-primary" >asdasdasd</button>` }
						}
					},   // 강의번호
					{ data: 'lectVO.lectNm', title: '강의명' },     // 강의명
					{ data: 'personVO.id', title: '학번' },         // 학번
					{ data: 'personVO.nm', title: '이름' },         // 이름
					{
						data: null,
						title: '조회버튼',
						render: function(data, type, row) {
							// 버튼 클릭 시 row 데이터 전달
							return `<button class="btn btn-primary" 
                                onclick="showDetails('${row.lectVO.lectNo}', '${row.personVO.id}')">조회</button>`;
						}
					}
				]
			});

		}, error: function(request, status, error) {
			console.log("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
		}
	});
}


function showDetails(a, b) {
	console.log(a, b)
}





 */ 