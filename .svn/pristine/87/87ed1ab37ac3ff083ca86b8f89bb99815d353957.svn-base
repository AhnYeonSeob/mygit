<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://www.springframework.org/tags/form" prefix="form"%>
<%@ taglib uri="http://www.springframework.org/tags" prefix="spring"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt"%>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="security"%>

<security:authentication property="principal.username" var="id" />

<input type="hidden" id="contextPath" value="${pageContext.request.contextPath}">
<input type="hidden" id="id" value="${my.id}">
<script>
    const contextPath = "${pageContext.request.contextPath}";
</script>
<script>
    const studentData = {
        id: "${my.id}",
        name: "${my.nm}",
        phone: "${my.mbtlnum}",
        email: "${my.eml}"
    };
</script>

<style>


.profile .profile-card img {
  max-width: 120px;
}

.profile .profile-card h2 {
  font-size: 24px;
  font-weight: 700;
  color: #2c384e;
  margin: 10px 0 0 0;
}

.profile .profile-card h3 {
  font-size: 18px;
}

.profile .profile-card .social-links a {
  font-size: 20px;
  display: inline-block;
  color: rgba(1, 41, 112, 0.5);
  line-height: 0;
  margin-right: 10px;
  transition: 0.3s;
}

.profile .profile-card .social-links a:hover {
  color: #012970;
}

.profile .profile-overview .row {
  margin-bottom: 20px;
  font-size: 15px;
}

.profile .profile-overview .card-title {
  color: #012970;
}

.profile .profile-overview .label {
  font-weight: 600;
  color: rgba(1, 41, 112, 0.6);
}

.profile .profile-edit label {
  font-weight: 600;
  color: rgba(1, 41, 112, 0.6);
}

.profile .profile-edit img {
  max-width: 120px;
}

</style>


<!-- 모달 -->
<div class="modal fade" id="studentCardModal" tabindex="-1" aria-labelledby="studentCardModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="studentCardModalLabel">학생증 신청</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 학생 정보 -->
                <div class="text-center mb-3">
                    <img src="data:image/jpeg;base64,${fn:escapeXml(my.proflPhoto)}" alt="Student Photo" class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover;">
                </div>
                <div class="mb-3"><strong>이름:</strong> ${my.nm}</div>
                <div class="mb-3"><strong>학번:</strong> ${my.id}</div>
                <div class="mb-3"><strong>전화번호:</strong> ${my.mbtlnum}</div>
                <div class="mb-3"><strong>이메일:</strong> ${my.eml}</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="confirmApplication">신청</button>
            </div>
        </div>
    </div>
</div>

<div class="container">
  <!-- 프로필 카드 -->
  <div class="row">
    <div class="col-12 mb-4">
      <div class="card">
        <div class="card-body profile-card pt-4 d-flex flex-column align-items-center">
          <c:choose>
            <c:when test="${not empty my.proflPhoto}">
              <img 
                src="data:image/jpeg;base64,${fn:escapeXml(my.proflPhoto)}" 
                alt="Profile Photo" 
                class="rounded-circle" 
                style="width: 150px; height: 150px; object-fit: cover;" />
            </c:when>
            <c:otherwise>
              <img 
                src="${pageContext.request.contextPath}/resources/NiceAdmin/assets/img/default-profile.jpg" 
                alt="Default Profile Photo" 
                class="rounded-circle" 
                style="width: 150px; height: 150px; object-fit: cover;" />
            </c:otherwise>
          </c:choose>


          <br>
          <h2>${my.nm}</h2>
          <h4>${my.id}</h4>
        </div>
      </div>
    </div>
  </div>

  <!-- 정보 탭 -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body pt-3">
          <!-- Bordered Tabs -->
          <ul class="nav nav-tabs nav-tabs-bordered">
          <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#profile-overview">기본 정보</button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#profile-additional">전체 성적</button>
          </li>
<!--           사용 시 활성화 -->
<!--           <li class="nav-item"> -->
<!--             <button class="nav-link" data-bs-toggle="tab" data-bs-target="#profile-other">기타 정보</button> -->
<!--           </li> -->
        </ul>

          <!-- 탭 콘텐츠 -->
        <div class="tab-content pt-2">
          <!-- 기본 정보 -->
          <div class="tab-pane fade show active" id="profile-overview">
            <h5 class="card-title">Profile Details</h5>
              <div class="row">
                <div class="col-lg-3 col-md-4 label">name</div>
                <div class="col-lg-9 col-md-8">${my.nm}</div>
              </div>
              <br>
              <div class="row">
                <div class="col-lg-3 col-md-4 label">학번</div>
                <div class="col-lg-9 col-md-8">${my.id}</div>
              </div>
              <br>
              <div class="row">
                <div class="col-lg-3 col-md-4 label">생년월일</div>
                <div class="col-lg-9 col-md-8">${my.brdt}</div>
              </div>
              <br>
              <div class="row">
                <div class="col-lg-3 col-md-4 label">주소</div>
                <div class="col-lg-9 col-md-8">${my.zip}</div>
              </div>
              <br>
              <div class="row">
                <div class="col-lg-3 col-md-4 label">전화번호</div>
                <div class="col-lg-9 col-md-8">${my.mbtlnum}</div>
              </div>
              <br>
              <div class="row">
                <div class="col-lg-3 col-md-4 label">이메일</div>
                <div class="col-lg-9 col-md-8">${my.eml}</div>
              </div>
              <br>
              <div class="row">
			   <div class="col-lg-3 col-md-4 label">수신 여부</div>
			    <div class="col-lg-9 col-md-8">
			        <!-- 이메일 수신 여부 -->
				<div class="form-check d-inline-block me-4">
				    <input type="checkbox" class="form-check-input" id="emailSubscription" name="emlRcptnAgreYn" value="Y" 
				           ${my.emlRcptnAgreYn == 'Y' ? 'checked' : ''} disabled>
				    <label class="form-check-label" for="emailSubscription">이메일 수신</label>
				</div>
				
				<div class="form-check d-inline-block">
				    <input type="checkbox" class="form-check-input" id="smsRcptnAgreYn" name="smsRcptnAgreYn" value="Y" 
				           ${my.smsRcptnAgreYn == 'Y' ? 'checked' : ''} disabled>
				    <label class="form-check-label" for="smsRcptnAgreYn">SMS 수신</label>
				</div>

			    </div>
			</div>
			<div class="row mt-3">
			    <div class="col-lg-12 d-flex justify-content-end gap-2">
			        <a href="${pageContext.request.contextPath}/mypage/${my.id}/auth" class="btn btn-primary">수정</a>
			      <security:authorize access="hasRole('STUDENT')">
			       <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#studentCardModal">학생증 신청</button>
					</security:authorize>
			    </div>
			</div>
           </div>
          <!-- 성적 조회 -->
          <div class="tab-pane fade" id="profile-additional">
            <h5 class="card-title">Additional Information</h5>
            <!-- 추가 정보 내용 -->
               <div>
                 <canvas id="myChart"></canvas>
              </div>
          </div>
		 <!-- 기타 정보 사용시 활성화 -->
<!--           <div class="tab-pane fade" id="profile-other"> -->
<!--             <h5 class="card-title">Other Information</h5> -->
<!--             기타 정보 내용 -->
<!--           </div> -->
<!--           </div> -->
          
          <!-- End 탭 콘텐츠 -->
        </div>
      </div>
    </div>
  </div>
</div>
<script src="${pageContext.request.contextPath }/resources/js/mypage/myPageStudentCardForm.js"></script>
<script src="${pageContext.request.contextPath }/resources/js/mypage/myPageScoreScript.js"></script>
  
   <script>
  

  document.addEventListener("DOMContentLoaded", function () {
	    const isFreshman = "${isFreshman}" === "true";
	    const id = "${my.id}";
	    const contextPath = document.getElementById("contextPath").value;

	    console.log("contextPath:", contextPath);
	    console.log("Final Redirect URL:", contextPath + "/mypage/" + id + "/UpdateMyPage");

	    if (isFreshman) {
	        swal({
	            title: "신입생 확인",
	            text: "신입생입니다. 정보 수정 페이지로 이동합니다.",
	            icon: "info",
	            button: "확인"
	        }).then(() => {
	            const redirectUrl = contextPath + "/mypage/" + id + "/UpdateMyPage";
	            window.location.href = redirectUrl;
	        });
	    }
	});




</script>