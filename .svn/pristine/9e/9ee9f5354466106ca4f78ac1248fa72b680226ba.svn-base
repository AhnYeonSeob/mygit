/**
 * 
 */
document.addEventListener("DOMContentLoaded", async () => {
	const cp = document.querySelector("#contextPath").value;

	// 오늘 날짜를 YYYY-MM-DD 형식으로 설정
	const today = new Date().toISOString().split('T')[0];
	const logDateInput = document.querySelector("#logData");

	console.log(today)

	logDateInput.max = today;
	logDateInput.value = today;
	// 오늘 날짜를 최대값으로 설정
	// 초기 데이터 로드
	await getTraficData(cp);

	// 날짜 변경 이벤트 리스너 추가
	logDateInput.addEventListener('change', async () => {
		await getTraficData(cp);
	});
});

async function getTraficData(cp) {
	const logDate = document.querySelector("#logData").value;
	const date = logDate.replace(/-/g, '');

	try {
		const resp = await fetch(`${cp}/log/trafic/${date}`);
		const data = await resp.json();
		
		console.log(data)
		//const filterData = fnRemoveUnderProperties(data);
		
		const chartData = {
			datasets: [{
				label: '기능별 요청량',
				data: data.traficLogList.map((item, index) => ({
					x: index,
					y: item.logCount,
					r: Math.sqrt(item.logCount) * 3.3, // 버블 크기 조정
				})),
				backgroundColor: 'rgba(54, 162, 235, 0.5)',
				borderColor: 'rgba(54, 162, 235, 1)',
				borderWidth: 1
			}]
		};
		const options = {
			responsive: true,
			maintainAspectRatio: false,
			plugins: {
				title: {
					display: true,
					text: `${logDate} 사용량`,
					align: 'center',
					position: 'top',
					font: {
						size: 16,
						weight: 'bold'
					},
					padding: {
						top: 10,
						bottom: 30
					}
				},
				tooltip: {

					callbacks: {
						label: function(context) {
							const item = data.traficLogList[context.dataIndex];
							let name = item.logContNm.replace('Controller', '');

							// 영문을 한글로 매핑
							const koreanNames = {
								'LectureMaterials': '강의자료',
								'ProjectChat': '프로젝트 채팅',
								'JobTest': '취업시험',
								'Lecture': '강의',
								'Attendee': '출석',
								'AbsenceCertificateReceipt': '결석증명서',
								'Noticeboard': '공지사항',
								'ProjectTask': '프로젝트 과제',
								'ProjectPersonal': '프로젝트 개인',
								'person': '사용자',
								'SecondStepAuth': '2차인증',
								'Mypage': '마이페이지',
								'Session': '세션',
								'ProjectTeam': '프로젝트 팀',
								'AdminTrafic': '관리자 트래픽',
								// 필요한 만큼 매핑 추가
							};

							const koreanName = koreanNames[name] || name; // 매핑된 한글명이 없으면 원래 이름 사용
							return `${koreanName}: ${item.logCount}회 요청`;
						}
					}
				},

				legend: {
					position: 'top',
					labels: {
						boxWidth: 10
					}
				}
			},
			scales: {
				x: {
					grid: {
						display: true,
						color: 'rgba(0, 0, 0, 0.1)',
						size: '10px'
					},
					ticks: {
						autoSkip: false
					},
					title: {
						display: true,
						text: '기능 갯수'
					}

				},
				y: {
					beginAtZero: true,
					grid: {
						display: true,
						color: 'rgba(0, 0, 0, 0.1)'
					},
					title: {
						display: true,
						text: '요청 횟수'
					}
				}
			}
		};
		// 기존 차트 제거
		if (window.myBubbleChart) {
			window.myBubbleChart.destroy();
		}

		// 새 차트 생성
		window.myBubbleChart = new Chart(
			document.getElementById('trafficChart'),
			{
				type: 'bubble',
				data: chartData,
				options: options
			}
		);
		
		
console.log(data.traficMethodLogList)
		// 원형 차트 데이터 준비
const circleChartData = {
    labels: data.traficMethodLogList.map(item => {
        let method = item.logMethod;

    switch (method) {
        case 'GET':
            method = '조회';
            break;
        case 'POST':
            method = '생성';
            break;
        case 'PUT':
            method = '수정';
            break;
        case 'DELETE':
            method = '삭제';
            break;
        default:
            method = method; // 기본값은 영어 그대로
            break;
    }

    return method;
			
    }),


    datasets: [{
        data: data.traficMethodLogList.map(item => item.logCount),
        backgroundColor: [
            'rgba(255, 99, 132, 0.5)',
            'rgba(54, 162, 235, 0.5)',
            'rgba(255, 206, 86, 0.5)',
            'rgba(75, 192, 192, 0.5)',
            'rgba(153, 102, 255, 0.5)'
        ],
        borderColor: [
            'rgba(255, 99, 132, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(153, 102, 255, 1)'
        ],
        borderWidth: 1
    }]
};

const circleOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        title: {
            display: true,
            text: '사용자 요청 비율',
            font: {
                size: 16,
                weight: 'bold'
            }
        },
        legend: {
            position: 'bottom',
            labels: {
                padding: 20
            }
        },
        tooltip: {
            callbacks: {
                label: function(context) {
                    const label = context.label || '';
                    const value = context.raw || 0;
                    const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
                    const percentage = ((value / total) * 100).toFixed(1);
                    return `${label}: ${value}회 (${percentage}%)`;
                }
            }
        }
    }
};

// 기존 원형 차트 제거
if (window.myCircleChart) {
    window.myCircleChart.destroy();
}

// 새 원형 차트 생성
window.myCircleChart = new Chart(
    document.getElementById('circleChart'),
    {
        type: 'doughnut',
        data: circleChartData,
        options: circleOptions
    }
);
		

	} catch (error) {
		console.error('Error:', error);
	}
}


let fnRemoveUnderProperties = function(obj) {
	if (typeof obj !== 'object' || obj === null) {
		return obj; // 객체가 아니거나 null인 경우 그대로 반환
	}

	// 객체를 복제하면서 null이 아닌 값만 유지
	if (Array.isArray(obj)) {
		return obj.map(item => fnRemoveNullProperties(item)).filter(item => item !== null);
	}

	const result = {};
	for (const key in obj) {
		if (obj[key] !== null) {
			result[key] = fnRemoveNullProperties(obj[key]);
		}
	}
	return result;
};






