<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn"%>

<style>

.card {
    border: 1px solid #000;
}
.card-header {
    background-color: #f8f9fa;
    font-weight: bold;
}
.card-footer {
    background-color: #f8f9fa;
}

</style>
<input type="hidden" id="form-table" data-auth="${pageContext.request.userPrincipal.name }" data-path="${pageContext.request.contextPath }" value="${lecture.lectNo }">

  <div class="container mt-4">
    <h1 class="text-center mb-4">과제 제출 관리</h1>
    접속: ${pageContext.request.userPrincipal.name  }
    <!-- 과제 리스트 -->
    <div class="accordion" id="assignmentAccordion">
        <c:forEach var="assignment" items="${assignmentList}" varStatus="status">
            <div class="accordion-item">
                <!-- 과제 제목 -->
                <div class="accordion-header d-flex justify-content-between align-items-center" id="heading-${assignment.assigNo}">
                    <span class="fw-bold text-primary" role="button" data-bs-toggle="modal" 
                          data-bs-target="#assignmentModal-${assignment.assigNo}">
                        과제명: ${assignment.assigNm}
                    </span>
                    <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" 
                            data-bs-target="#collapse-${assignment.assigNo}" 
                            aria-expanded="false" aria-controls="collapse-${assignment.assigNo}">
                        제출 과제 보기
                    </button>
                </div>

                <!-- 제출 과제 리스트 -->
                <div id="collapse-${assignment.assigNo}" class="accordion-collapse collapse" 
                     aria-labelledby="heading-${assignment.assigNo}" data-bs-parent="#assignmentAccordion">
                    <div class="accordion-body">
                        <h5 class="mt-3">제출된 과제</h5>
                        <hr style="border: 2px solid blue;"/>
                        <div class="list-group">
                            <c:forEach var="submission" items="${assignment.assignmentsubmissionList}">
                            <c:if test="${submission.assubYn eq 'Y' }">
                                <div class="list-group-item">
                                	<table class="table table-bordered">
                                		<tr class="text-center">
                                			<th>학번</th>
                                			<td colspan="2">${submission.stuId}</td>
                                		</tr>
                                		<tr class="text-center">
                                			<th>제출일 | 제출마감일</th>
                                			<td>${fn:substring(submission.assubDate, 0, 4)}-${fn:substring(submission.assubDate, 4, 6)}-${fn:substring(submission.assubDate, 6, 8)}</td>
                                			<td>${fn:substring(assignment.assigEd, 0, 4)}-${fn:substring(assignment.assigEd, 4, 6)}-${fn:substring(assignment.assigEd, 6, 8)}</td>
                                		</tr>
                                		<tr class="text-center">
                                			<th>과제점수 | 배점</th>
                                			<c:if test="${fn:substring(pageContext.request.userPrincipal.name, 4, 6) eq '30'}">
	                                			<td><input id="inputGrade" type="number" max="${assignment.assigScore }" min="0" value="${submission.assubScore }"></td>
	                                			<td>${assignment.assigScore }</td>
                                			</c:if>
                                			<c:if test="${fn:substring(pageContext.request.userPrincipal.name, 4, 6) eq '10' and pageContext.request.userPrincipal.name eq submission.stuId}">
                                				<td>${submission.assubScore }</td>
                                				<td>${assignment.assigScore }</td>
                                			</c:if>
                                		</tr>
                                		<tr class="text-center">
                                			<th>첨부파일</th>
                                			<td colspan="2">
					                            <c:forEach items="${submission.atchFile.fileDetails }" var="sufd" varStatus="suvs">
												<c:url value='/atch/${sufd.atchFileId }/${sufd.fileSn }' var="downUrl"/>
												<a href="${downUrl }">${sufd.orignlFileNm }(${sufd.fileFancysize })</a>
													${not suvs.last ? '|' : ''}
												</c:forEach>
												<c:if test="${empty submission.atchFile.fileDetails}">
												    첨부파일없음
												</c:if>
											</td>
                                		</tr>
                                		<tr>
				                            <th class="text-center">내용</th>
				                            <td colspan="2">${submission.assubNotes}</td>
				                        </tr>
				                        <c:if test="${fn:substring(pageContext.request.userPrincipal.name, 4, 6) eq '30' }">
				                        <tr class="text-end">
				                        	<td colspan="3">
				                        	<c:if test="${submission.assubYn eq 'Y' and  submission.peerYn eq 'Y'}">
				                        		<button id="gradeBtn" class="btn btn-primary"
				                        		data-limit="${assignment.assigScore }"
				                        		data-stuid="${submission.stuId }"
				                        		data-assigno="${submission.assigNo }"
				                        		>채점</button>
				                        	</c:if>
				                        	</td>
				                        </tr>
				                        </c:if>
                                	</table>
                                </div>
                                <hr style="border: 2px solid blue;"/>
                                </c:if>
                                <c:if test="${submission.assubYn eq 'N'  }">
                            	제출된 과제없음
                          		</c:if>
                            </c:forEach>
                        </div>
                    </div>
                </div>
            </div>
        </c:forEach>
    </div>
</div>

<script src="${pageContext.request.contextPath }/resources/js/assignmentSubmission/assignmentSubmission.js"></script>