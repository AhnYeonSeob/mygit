<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.yguniv.graduation.dao.GraduationMapper">
<resultMap type="GraduationVO" id="GraduationMap" autoMapping="true">
	<id property="gdtCd" column="GDT_CD"/>
	<id property="codeName" column="CODENAME"/>
	<result property="atchFileId" column="ATCH_FILE_ID" />
	<association property="atchFile" column="ATCH_FILE_ID"
		select ="kr.or.ddit.yguniv.atch.dao.AtchFileMapper.selectAtchFileEnable"/>
</resultMap>

	<!-- 전체 게시글 수 조회 -->
	<select id="selectTotalRecord" resultType="int">
	    SELECT COUNT(GDT_CD)
	    FROM GRADUATION
	    <where>
	        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(simpleCondition.searchWord)">
	            <choose>
	                <when test="simpleCondition.searchType eq 'number'">
	                    INSTR(STU_ID, #{simpleCondition.searchWord}) > 0
	                </when>
	                <when test="simpleCondition.searchType eq 'name'">
	                    INSTR(CODENAME, #{simpleCondition.searchWord}) > 0
	                </when>
	                 <when test="simpleCondition.searchType eq 'type'">
	                    INSTR(TYPE, #{simpleCondition.searchWord}) > 0
	                </when>
	                <otherwise>
	                    (INSTR(STU_ID, #{simpleCondition.searchWord}) > 0
	                    OR INSTR(CODENAME, #{simpleCondition.searchWord}) > 0
	                    OR INSTR(TYPE, #{simpleCondition.searchWord}) > 0
	                </otherwise>
	            </choose>
	        </if>
	    </where>
	</select>


	<insert id="insertgraduation" parameterType="GraduationVO">
	
		<selectKey order="BEFORE" resultType="int" keyProperty="gdtCd">
	        SELECT SEQ_GRADUATION.NEXTVAL FROM DUAL
	    </selectKey>
			INSERT INTO GRADUATION (
			       GDT_CD
			     , STU_ID
			     , EMP_ID
			     , GDT_TYPE
			     , GDT_NM
			     , GDT_INST
			     , GDT_ISSU
			     , GDT_SCORE
			     , ATCH_FILE_ID
			     , COCO_CD
			)
			VALUES(
			     #{gdtCd, jdbcType=NUMERIC}
			    , #{stuId, jdbcType=VARCHAR}
			    ,(SELECT EMP_ID FROM (
			        SELECT EMP_ID 
			        FROM EMPLOYEE 
			        WHERE EMP_CD = 'UE03' 
			        ORDER BY DBMS_RANDOM.VALUE 
			    ) WHERE ROWNUM = 1)
			    , #{gdtType, jdbcType=VARCHAR}
			    , #{gdtNm, jdbcType=VARCHAR}
			    , #{gdtInst, jdbcType=VARCHAR}
			    , TO_CHAR(TO_DATE(#{gdtIssu, jdbcType=VARCHAR}, 'YYYY-MM-DD'), 'YYYYMMDD')
			    , #{gdtScore, jdbcType=NUMERIC}
			   	, #{atchFileId, jdbcType=NUMERIC}
			    , 'G003'                  
			)
	</insert>
	
	<select id="selectgraduationList" resultMap="GraduationMap" >
		SELECT 
			  G.GDT_CD
			, G.STU_ID
			, G.EMP_ID
			, G.GDT_TYPE
			, (SELECT COCO_STTS FROM COMMON_CODE C WHERE G.GDT_TYPE=C.COCO_CD)AS TYPE
			, G.GDT_NM
			, G.GDT_INST
			, TO_CHAR(TO_DATE(G.GDT_ISSU, 'YYYYMMDD'), 'YYYY-MM-DD') AS GDT_ISSU
			, G.GDT_SCORE
			, G.COCO_CD
			, (SELECT COCO_STTS FROM COMMON_CODE C WHERE G.COCO_CD=C.COCO_CD) AS CODENAME
 
		FROM GRADUATION G
		WHERE STU_ID=#{stuId, jdbcType=VARCHAR}
	
	</select>
	
	<select id="selectgraduationListByEmp" resultMap="GraduationMap" >
		SELECT *
		FROM (
			SELECT A.*, ROWNUM AS RNUM
			FROM(
				SELECT 
					  G.GDT_CD
					, G.STU_ID
					, G.EMP_ID
					, G.GDT_TYPE
					, (SELECT COCO_STTS FROM COMMON_CODE C WHERE G.GDT_TYPE=C.COCO_CD)AS TYPE
					, G.GDT_NM
					, G.GDT_INST
					, TO_CHAR(TO_DATE(G.GDT_ISSU, 'YYYYMMDD'), 'YYYY-MM-DD') AS GDT_ISSU
					, G.GDT_SCORE
					, G.COCO_CD
					, (SELECT COCO_STTS FROM COMMON_CODE C WHERE G.COCO_CD=C.COCO_CD) AS CODENAME
		 
				FROM 
					GRADUATION G
				        WHERE 1=1
                   <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(simpleCondition.searchWord)">
                    AND
                     <choose>
	                <when test="simpleCondition.searchType eq 'number'">
	                    INSTR(STU_ID, #{simpleCondition.searchWord}) > 0
	                </when>
	                <when test="simpleCondition.searchType eq 'name'">
	                    INSTR(CODENAME, #{simpleCondition.searchWord}) > 0
	                </when>
	                 <when test="simpleCondition.searchType eq 'type'">
	                    INSTR(TYPE, #{simpleCondition.searchWord}) > 0
	                </when>
	                <otherwise>
	                    (INSTR(STU_ID, #{simpleCondition.searchWord}) > 0
	                    OR INSTR(CODENAME, #{simpleCondition.searchWord}) > 0
	                    OR INSTR(TYPE, #{simpleCondition.searchWord}) > 0
	                </otherwise>
	            </choose>
                </if>
            <![CDATA[
            ORDER BY GDT_ISSU DESC
            ) A
            WHERE ROWNUM <= #{endRow}
        ) B
        WHERE RNUM >= #{startRow}
    ]]>
	</select>
	
	<select id="selectgraduationByCd" resultMap="GraduationMap">
		SELECT 
			  G.GDT_CD
			, G.STU_ID
			, G.EMP_ID
			, G.GDT_TYPE
			, (SELECT COCO_STTS FROM COMMON_CODE C WHERE G.GDT_TYPE=C.COCO_CD)AS TYPE
			, G.GDT_NM
			, G.GDT_INST
			, TO_CHAR(TO_DATE(G.GDT_ISSU, 'YYYYMMDD'), 'YYYY-MM-DD') AS GDT_ISSU
			, G.GDT_SCORE
			, G.COCO_CD
			, (SELECT COCO_STTS FROM COMMON_CODE C WHERE G.COCO_CD=C.COCO_CD) AS CODENAME
 
		FROM GRADUATION G
		WHERE G.GDT_CD=#{gdtCd, jdbcType=VARCHAR}
	</select>
	
	
	
	
	<!-- 	봉사활동 점수 합산 -->
	<select id="selectTotalVolunteerScore" resultType="int">
	    SELECT SUM(GDT_SCORE)
	    FROM GRADUATION
	    WHERE STU_ID = #{stuId} AND GDT_TYPE = 'GT01'
	</select>
	
	
	
	<select id="selectgraduation"></select>
	<update id="updategraduation"></update>
	<delete id="deletegraduation"></delete>
</mapper>