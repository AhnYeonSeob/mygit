<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://www.springframework.org/tags/form" prefix="form"%>
<%@ taglib uri="http://www.springframework.org/tags" prefix="spring"%>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="security"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>

<nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">장학금 추천/ 신청서 목록</li>
    <li class="breadcrumb-item active" aria-current="page">장학금 추천/신청서 상세조회</li>
  </ol>
</nav>


<input type="hidden" id="approvalDateInput" name="shapChcDate" value="${ask.shapChcDate}" />
<input type="hidden" name="shapDocNo" value="${ask.shapDocNo}" />

<script>
    const contextPath = "${pageContext.request.contextPath}/";
</script>
<style>
/* 메인 테이블 스타일 */

th{
text-align: center;
width: 180px;
}
.table {
    width: 70%;
    margin: 0 auto;
    border-collapse: collapse;
}
th, td {
    padding: 10px;
    text-align: center;
    vertical-align: middle;
    border: 1px solid #ddd;
}




</style>
<br>
<div class="modal" id="rejectReasonModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">반려 사유 입력</h5>
            </div>
            <div class="modal-body">
                <textarea id="rejectReason" class="form-control" rows="4" placeholder="반려 사유를 입력하세요."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" id="saveRejectReasonButton" class="btn btn-primary">저장</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
            </div>
        </div>
    </div>
</div>


<form id="updateStatusForm" action="${pageContext.request.contextPath}/askAward/updateStatus" method="POST">
    <table class="table table-primary">
			<tr>
			    <th>상태</th>
			    
			    <td class="bg-light" style="display: flex; align-items: center;" colspan="3">
			        <!-- Hidden Inputs -->
			        <input type="hidden" id="approvalDateInput" name="shapChcDate" value="${ask.shapChcDate}" />
			        <input type="hidden" name="shapDocNo" value="${ask.shapDocNo}" />
			
			        <!-- 상태 선택 -->
			        <select id="statusSelect" name="cocoStts" class="form-select" style="width: 150px;">
			            <option value="A01" ${ask.commonCodeVO.cocoCd == 'A01' ? 'selected' : ''}>대기</option>
			            <option value="A02" ${ask.commonCodeVO.cocoCd == 'A02' ? 'selected' : ''}>접수</option>
			            <option value="A03" ${ask.commonCodeVO.cocoCd == 'A03' ? 'selected' : ''}>승인</option>
			            <option value="A04" ${ask.commonCodeVO.cocoCd == 'A04' ? 'selected' : ''}>반려</option>
			        </select>
			    </td>
			   
			</tr>


        <tr>
            <th>학기번호</th>
            <td  class="bg-light">${fn:substring(ask.semstrNo, 0, 4)}-${fn:substring(ask.semstrNo, 4, 6)}</td>
            
            <th>장학금 유형</th>
            <td  class="bg-light">${ask.awardVO.awardNm}</td>
        </tr>
      
        <tr>
            <th>학번</th>
            <td  class="bg-light">${ask.stuId}</td>
            <th>이름</th>
            <td  class="bg-light">${ask.studentVO.nm}</td>
        </tr>
        <tr>
            <th>생년월일</th>
            <td colspan="3"  class="bg-light">
                ${fn:substring(fn:replace(ask.studentVO.brdt, '-', ''), 0, 4)}년&nbsp;
                ${fn:substring(fn:replace(ask.studentVO.brdt, '-', ''), 4, 6)}월&nbsp;
                ${fn:substring(fn:replace(ask.studentVO.brdt, '-', ''), 6, 8)}일
            </td>
        </tr>
        <tr>
            <th>이메일</th>
            <td colspan="3"  class="bg-light">${ask.studentVO.eml}</td>
        </tr>
        <tr>
            <th>전화번호</th>
            <td colspan="3"  class="bg-light">${ask.studentVO.mbtlnum}</td>
        </tr>
        <tr>
            <th>집주소</th>
            <td colspan="3"  class="bg-light">(${ask.studentVO.zip}) &nbsp; ${ask.studentVO.rdnmadr} &nbsp; ${ask.studentVO.daddr}</td>
        </tr>
        <tr>
            <th>첨부파일</th>
            <td colspan="3"  class="bg-light">
                <c:forEach items="${ask.atchFile.fileDetails}" var="fd" varStatus="vs">
                    <c:url value='/askAward/${ask.shapDocNo}/atch/${fd.atchFileId}/${fd.fileSn}' var="downUrl"/>
                    <a href="${downUrl}">${fd.orignlFileNm} (${fd.fileFancysize})</a>
                    ${not vs.last ? '|' : ''}
                </c:forEach>
                <c:if test="${empty ask.atchFile.fileDetails}">첨부파일 없음</c:if>
            </td>
        </tr>
    </table>
    
    <!-- 반려사유 섹션 -->
<div id="approvalAndReason" style="display: none; margin-top: 20px;">
    <table class="table table-primary">
        <tr>
            <th style="text-align: center;">반려사유</th>
            <td class="bg-light">
                <c:if test="${empty ask.shapNoReason}">
                    - <!-- 반려사유 없음 -->
                </c:if>
                <c:if test="${not empty ask.shapNoReason}">
                    <span style="color: red;">${ask.shapNoReason}</span> <!-- 반려사유 표시 -->
                </c:if>
            </td>
        </tr>
    </table>
</div>
    

    <div align="right" >
        <a href="<c:url value='/askAward'/>" class="btn btn-primary">목록</a>
        
    </div>
</form>

<script>
    // 반려사유 표시 여부 제어
    document.addEventListener("DOMContentLoaded", function () {
        const statusSelect = document.getElementById("statusSelect").value;
        console.log("statusSelect가 뭐야? ", statusSelect)
        const approvalAndReasonDiv = document.getElementById("approvalAndReason");

        // 상태 변경 이벤트 핸들러
        statusSelect.addEventListener("change", function () {
            const selectedValue = statusSelect.value;
            

            if (selectedValue === "A04") { // 반려 상태
                approvalAndReasonDiv.style.display = "block";
            } else {
                approvalAndReasonDiv.style.display = "none";
            }
        });

        // 페이지 로드 시 초기 상태 반영
        if (statusSelect.value === "A04") {
            approvalAndReasonDiv.style.display = "block";
        }
    });
</script>

<script src="${pageContext.request.contextPath }/resources/js/awardAsk/awardAsKStatus.js"></script>
<%-- <script src="${pageContext.request.contextPath }/resources/js/awardAsk/awardAskReason.js"></script> --%>

