package kr.or.ddit.yguniv.person.controller;

import java.util.List;

import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import kr.or.ddit.yguniv.commons.enumpkg.ServiceResult;
import kr.or.ddit.yguniv.commons.exception.PKNotFoundException;
import kr.or.ddit.yguniv.person.service.PersonService;
import kr.or.ddit.yguniv.vo.EmployeeVO;
import kr.or.ddit.yguniv.vo.PersonVO;
import kr.or.ddit.yguniv.vo.ProfessorVO;
import kr.or.ddit.yguniv.vo.StudentVO;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@RequestMapping("/person")
@Controller
@RequiredArgsConstructor
public class personController {
	
	private final PersonService service;
	
	public static final String MODELNAME = "person";
	
	@ModelAttribute(MODELNAME)
	public PersonVO member() {
		return new PersonVO();
	}
	
	//form으로 보냄
	@GetMapping("new")
	public String createForm() {
		return "person/personForm";
	}
	
//	 @GetMapping("/updateform/{personId}")
//	    public String getUpdateForm(@RequestParam("id") String personId, Model model) {
//	        // 데이터베이스에서 personId에 해당하는 사용자 정보를 가져옴
//	        PersonVO person = service.readPerson(personId);
//
//	        // 모델에 데이터 추가
//	        model.addAttribute("person", person);
//
//	        // personUpdate.jsp 반환
//	        return "person/personUpdate";
//	    }
	
	//전체조회(검색어 있는지 없는지)
	@GetMapping("list")
	public String selectlist(Model model) {
		List<PersonVO>personList = service.readPersonList();
		model.addAttribute("list", personList);
		
		return "person/personList";
	}
	
	//생성
	@PostMapping()
	public String create() {
		return "person/personDetail";
	}
	
	
	@GetMapping("detail/{personId}")
	@ResponseBody
	public PersonVO detailperson(@PathVariable String personId, Model model) {
	    PersonVO person = service.readPerson(personId);

	    if (person == null) {
	        throw new PKNotFoundException("사용자를 찾을 수 없습니다.");
	    }
	    if(person.getProfessor()!=null) {
	    	ProfessorVO professor = person.getProfessor();
	    	professor.setProfeId(person.getId());
	    	log.info("professor:{}", professor);
	    	service.selectProfessorDetail(professor);
	    	
	    }

	    return person; 
	}

	
	@PostMapping("create")
	public String insertPersonAndUser(@RequestBody PersonVO person, RedirectAttributes redirectAttributes) {
	    try {
	        ServiceResult res = service.createPerson(person);
	        if(res == ServiceResult.PKDUPLICATED) {
	            redirectAttributes.addFlashAttribute("message", "아이디 중복, 바꾸셈.");
	            return "person/personForm";
	        }
	        System.out.println("Person inserted successfully!");

	        // 교수 정보 삽입
	        if (person.getProfessor() != null) {
	            ProfessorVO professorVO = person.getProfessor();
	            professorVO.setProfeId(person.getId());
	            //log.info("ProfessorVO: {}", professorVO);
	            service.insertProfessor(professorVO);
	        }

	        // 직원 정보 삽입
	        if (person.getEmployee() != null) {
	            EmployeeVO employeeVO = person.getEmployee();
	            employeeVO.setEmpId(person.getId());
	           // log.info("EmployeeVO: {}", employeeVO);
	            service.insertEmployee(employeeVO);
	        }

//	        // 학생 정보 삽입 (추가적인 로직 필요 시)
//	        if (person.getStudent() != null) {
//	            StudentVO studentVO = person.getStudent();
//	            studentVO.setStudId(person.getId());
//	            log.info("StudentVO: {}", studentVO);
//	            service.insertStudent(studentVO);
//	        }

	        return "person/personList";  // 성공시 리다이렉트

	    } catch (Exception e) {
	        return "person/personForm";  // 오류시 다시 폼으로
	    }
	}
	
	//수정
	@GetMapping("edit/{personId}")
	@ResponseBody
	public PersonVO updateperson(@PathVariable String personId, Model model) {
		
		
		PersonVO person = service.readPerson(personId);
		
		if(person == null) {
			throw new PKNotFoundException();
		}
		
		return person;
	
	}
	
		
	//삭제
	@DeleteMapping("{personId}")
	public String delete(@PathVariable()int personId) {
		return "person/personList";
	}
	
	//교수 insert
	@PostMapping("newpro")
	public String professorcreateForm() {
		return "professor/professorInsert";
	}
	


}






