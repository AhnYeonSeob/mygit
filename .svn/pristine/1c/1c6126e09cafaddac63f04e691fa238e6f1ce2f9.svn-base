package kr.or.ddit.yguniv.mypage.service;


import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.core.context.SecurityContext;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import kr.or.ddit.yguniv.board.answerBoard.exception.BoardException;
import kr.or.ddit.yguniv.commons.enumpkg.ServiceResult;
import kr.or.ddit.yguniv.mypage.dao.MypageMapper;
import kr.or.ddit.yguniv.vo.PersonVO;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@RequiredArgsConstructor
@Slf4j
@Service
public class MypageServiceImpl implements MypageService {

    @Autowired
    private MypageMapper mapper;



    @Override
    public PersonVO selectPerson(String id) {
        PersonVO person = mapper.selectMyPage(id);
        log.info("id가 있는지 없는지 확인 {}", person);

        if (person == null) {
            throw new BoardException(String.format("%s 번 글이 없음.", id));
        }

        return person;
    }

    
    @Autowired
    private AuthenticationManagerBuilder authenticationManagerBuilder;
    
    @Override
    @Transactional
    public ServiceResult updatePerson(PersonVO person) {
    	log.info("업데이트 요청된 PersonVO: {}", person);
    	
    	ServiceResult result = null; 
    	 AuthenticationManager authService = authenticationManagerBuilder.getObject();
	      UsernamePasswordAuthenticationToken inputData =
	             new UsernamePasswordAuthenticationToken(person.getId(), person.getPswd());
	      try {
	    	    authService.authenticate(inputData); // 인증
	    	    log.info("Authentication 성공: ID={}, Password=****", person.getId());

	    	    // updateMyPage 실행
	    	    if (mapper.updateMyPage(person) > 0) {
	    	        log.info("updateMyPage 성공");

	    	        // MERGE 실행
	    	        log.info("MERGE 실행 전 Person ID: {}", person.getId());
	    	        int rowsUpdated = mapper.updateStudentCategoryWithMerge(person);
	    	        log.info("MERGE 실행 결과: {} rows updated", rowsUpdated);

	    	        if (rowsUpdated > 0) {
	    	            log.info("MERGE 성공적으로 실행됨");
	    	            result = ServiceResult.OK;
	    	            changeAuthentication(); // 인증 갱신
	    	        } else {
	    	            log.info("MERGE 실행되지 않음 (조건 불일치)");
	    	            result = ServiceResult.FAIL;
	    	        }
	    	    } else {
	    	        log.info("updateMyPage 실패");
	    	        result = ServiceResult.FAIL;
	    	    }
	    	} catch (AuthenticationException e) {
	    	    log.warn("Authentication 실패: 비밀번호가 올바르지 않음");
	    	    result = ServiceResult.INVALIDPASSWORD;
	    	}
	    	return result;

    	
    }

    private void changeAuthentication() {
		   // 현재 인증객체를 새로운 인증 객체로 변경
       Authentication inputData =  SecurityContextHolder.getContext().getAuthentication();
        log.info("authentication : { }", inputData );
        inputData.getAuthorities();
        
        
        
      AuthenticationManager authService=  authenticationManagerBuilder.getObject();
     UsernamePasswordAuthenticationToken newAuthentication= (UsernamePasswordAuthenticationToken)authService.authenticate(inputData);  
      
      newAuthentication.setDetails(inputData.getDetails());
        SecurityContext newContext = SecurityContextHolder.createEmptyContext();
        newContext.setAuthentication(newAuthentication);
        SecurityContextHolder.setContext(newContext);
		
	}

    @Override
    public PersonVO authenticateUser(String id, String pswd) {
        // AuthenticationManager로 인증 처리
        try {
            UsernamePasswordAuthenticationToken token = new UsernamePasswordAuthenticationToken(id, pswd);
          AuthenticationManager authService =  authenticationManagerBuilder.getObject();
          authService.authenticate(token);
        } catch (AuthenticationException e) {
            throw new IllegalArgumentException("비밀번호가 일치하지 않습니다.");
        }

        // 인증 성공 시 사용자 정보 반환
        return mapper.selectMyPage(id);
    }
}



