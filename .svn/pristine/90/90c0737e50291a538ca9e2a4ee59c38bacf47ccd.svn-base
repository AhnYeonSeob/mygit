package kr.or.ddit.yguniv.noticeboard.service;

import static org.junit.jupiter.api.Assertions.*;

import java.io.File;
import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.time.LocalDate;
import java.util.Arrays;
import java.util.List;
import java.util.Optional;
import java.util.stream.Stream;

import org.apache.commons.io.FileUtils;
import org.apache.commons.lang3.ArrayUtils;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.mock.web.MockMultipartFile;
import org.springframework.transaction.annotation.Transactional;

import kr.or.ddit.yguniv.annotation.RootContextWebConfig;
import kr.or.ddit.yguniv.paging.PaginationInfo;
import kr.or.ddit.yguniv.paging.SimpleCondition;
import kr.or.ddit.yguniv.vo.AtchFileDetailVO;
import kr.or.ddit.yguniv.vo.AtchFileVO;
import kr.or.ddit.yguniv.vo.NoticeBoardVO;


@RootContextWebConfig
@Transactional
class NoticeBoardServiceImplTest {

	@Autowired
	NoticeBoardService service;
	
	NoticeBoardVO boardWithFiles;
	NoticeBoardVO boardWithNoFiles;
	
	@BeforeEach
	void beforeEach() throws IllegalAccessException, InvocationTargetException {
		boardWithFiles = new NoticeBoardVO();
		boardWithNoFiles = new NoticeBoardVO();
		boardWithFiles.setPrsId("작성자");
		boardWithFiles.setNtcNm("제목");
		boardWithFiles.setNtcDesc("내용");
		boardWithFiles.setNtcDt("2024200001");
		boardWithFiles.setNtcEt("2024200001");
		
		BeanUtils.copyProperties(boardWithFiles, boardWithNoFiles);

		AtchFileVO atchFile = new AtchFileVO();
		MockMultipartFile file1 = new MockMultipartFile("atchFile.fileDetails[0].boFiles", "test.jpg", "image/jpeg",
				ArrayUtils.EMPTY_BYTE_ARRAY);
		MockMultipartFile file2 = new MockMultipartFile("atchFile.fileDetails[1].boFiles", "test.jpg", "image/jpeg",
				ArrayUtils.EMPTY_BYTE_ARRAY);
		atchFile.setFileDetails(Arrays.asList(new AtchFileDetailVO(file1), new AtchFileDetailVO(file2)));
	
		assertDoesNotThrow(()->{
			boardWithFiles.setAtchFile(atchFile);
			service.createNoticeBoard(boardWithFiles);
		});
		
		assertDoesNotThrow(()->{
			boardWithNoFiles.setAtchFile(null);
			service.createNoticeBoard(boardWithNoFiles);
		});
		
	}
	
	@AfterEach
	void afterEach() {
		assertDoesNotThrow(() -> {
			Optional.ofNullable(boardWithFiles)
					.map(NoticeBoardVO::getAtchFile)
					.map(AtchFileVO::getFileDetails)
					.map(List::stream).orElse(Stream.empty())
					.filter(fd -> fd.getFileStreCours() != null)
					.forEach(fd -> FileUtils.deleteQuietly(new File(fd.getFileStreCours())));
			Optional.ofNullable(boardWithNoFiles)
					.map(NoticeBoardVO::getAtchFile)
					.map(AtchFileVO::getFileDetails)
					.map(List::stream).orElse(Stream.empty())
					.filter(fd -> fd.getFileStreCours() != null)
					.forEach(fd -> FileUtils.deleteQuietly(new File(fd.getFileStreCours())));
		});
	}
	
	@Test
	void testCreateBoardNoFiles() throws IOException {
	}

	@Test
	void testCreateBoardWithFiles() throws IOException {
	}
	
//	@Test//통과
//	void testCreateNoticeBoard() {
//		NoticeBoardVO board = service.readNoticeBoard(1);
//		board.setNtcNm("뉴제목22");
//		service.createNoticeBoard(board);
//	
//		
//	}

	
//	@Test//통과
//	void testReadNoticeBoard() {
//		service.readNoticeBoard(1);
//	}
//
//	@Test//통과
//	void testReadNoticeBoardList() {
//		service.readNoticeBoardList();
//	}
//
//	@Test//통과
//	void readNoticeBoardListPaging() {
//		PaginationInfo<NoticeBoardVO> paging = new PaginationInfo<>();
//		paging.setCurrentPage(1);
//		SimpleCondition simpleCondition = new SimpleCondition();
//		simpleCondition.setSearchWord("은대");
//		paging.setSimpleCondition(simpleCondition);
//		assertDoesNotThrow(() -> service.readNoticeBoardListPaging(paging));
//	}

//	@Test//통과
//	void testModifyNoticeBoard() {
//		NoticeBoardVO board = service.readNoticeBoard(1);
//		board.setNtcNm("변경제목11111");
//		assertDoesNotThrow(()->{
//			service.modifyNoticeBoard(board);
//		});
//	}
//
//	@Test
//	void testRemoveNoticeBoard() {
//		fail("Not yet implemented");
//	}
//
//	@Test
//	void testDownload() {
//		fail("Not yet implemented");
//	}
//
//	@Test
//	void testRemoveFile() {
//		fail("Not yet implemented");
//	}

}
