<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.yguniv.coursecart.dao.LectureCartMapper">
  <!-- Result Map 정의 -->
    <resultMap type="LectureVO" id="lectureListMap" autoMapping="true">
        <association property="commonCodeVO" autoMapping="true" javaType="CommonCodeVO">
            <id property="cocoCd" column="COCO_CD"/>
        </association>
        <association property="subjectVO" autoMapping="true" javaType="SubjectVO">
            <id property="subNo" column="SUB_NO"/>
        </association>
        <association property="professorVO" autoMapping="true" javaType="ProfessorVO">
            <id property="id" column="ID"/>
        </association>
        <collection property="scheduleVO" autoMapping="true" ofType="ScheduleVO">
            <association property="classRoomVO" autoMapping="true" javaType="ClassRoomVO"></association>
        </collection>
    </resultMap>

    <!-- Lecture List 쿼리 -->
    <select id="getLectureList" resultMap="lectureListMap">
        select
            l.lect_no,
            l.lect_nm,
            (select coco_stts from common_code where coco_cd = s.sub_ficd_cd) as sub_ficd_cd,
            c.coco_stts,
            p.nm,  -- 직접 JOIN한 person 테이블에서 nm을 가져옴
            l.lect_en_nope,
            (select count(*) from lecture_cart where lect_no = l.lect_no) as lect_atten_nope,
            l.lect_score,
            LISTAGG((select coco_stts from common_code where coco_cd = sc.date_cd) || '' || sc.edc_time_cd, ' / ') 
            WITHIN GROUP (ORDER BY sc.date_cd, sc.edc_time_cd) as joinSchedule,
            cr.croom_pstn
        from lecture l 
            inner join common_code c on l.lect_status_cd = c.coco_cd    
            inner join subject s on l.sub_no = s.sub_no
            inner join professor pro on l.profe_id = pro.profe_id
            inner join person p on pro.profe_id = p.id
            left outer join schedule sc on l.lect_no = sc.lect_no
            left outer join education_time_table_code ettc on ettc.edc_time_cd = sc.edc_time_cd
            left outer join class_room cr on sc.croom_cd = cr.croom_cd
        where l.lect_status_cd = 'L02'
        group by l.lect_no, l.lect_nm, sub_ficd_cd, c.coco_stts, p.nm, l.lect_en_nope, l.lect_score, cr.croom_pstn
    </select>

	<select id="getStudentLectureList" resultMap="lectureListMap">
select
    l.lect_no,
    l.lect_nm,
    (select coco_stts from common_code where coco_cd = s.sub_ficd_cd) as sub_ficd_cd,
    c.coco_stts,
    p.nm,  -- 직접 JOIN한 person 테이블에서 nm을 가져옴
    l.lect_en_nope,
    (select count(*) from lecture_cart where lect_no = l.lect_no) as lect_atten_nope,  -- 수정된 부분
    l.lect_score,
    LISTAGG((select coco_stts from common_code where coco_cd = sc.date_cd) || '' || sc.edc_time_cd, ' / ') WITHIN GROUP (ORDER BY sc.date_cd, sc.edc_time_cd) as joinSchedule,
    cr.croom_pstn
from lecture_cart lc 
    inner join lecture l on lc.lect_no = l.lect_no 
    inner join common_code c on l.lect_status_cd = c.coco_cd    
    inner join subject s on l.sub_no = s.sub_no
    inner join professor pro on l.profe_id = pro.profe_id
    inner join person p on pro.profe_id = p.id
    left outer join schedule sc on l.lect_no = sc.lect_no
    left outer join education_time_table_code ettc on ettc.edc_time_cd = sc.edc_time_cd
    left outer join class_room cr on sc.croom_cd = cr.croom_cd
where lc.stu_id=#{stuId} and l.lect_status_cd = 'L02'
group by l.lect_no, l.lect_nm, sub_ficd_cd, c.coco_stts, p.nm, l.lect_en_nope, l.lect_score, cr.croom_pstn
	
	</select>



    <!-- 다른 쿼리 -->
    <select id="selectLecturePaper"></select>

    <!-- Insert 쿼리 -->
    <insert id="insertCart" parameterType="LectureCartVO">
        INSERT INTO lecture_cart (
            stu_id,
            lect_no,
            cart_sttus_cd
        ) VALUES (
            #{stuId},
            #{lectNo},
            'WAIT'
        )
    </insert>

    <!-- Update 쿼리 -->
    <update id="updateCart"></update>

    <!-- Delete 쿼리 -->
    <delete id="deleteCart">
        DELETE FROM lecture_cart
        WHERE
        stu_id = #{stuId}  
        AND lect_no = #{lectNo}
    </delete>
	
	<select id="selectCart" resultType="Integer">
		select *
		from lecture_cart
		where 
				stu_id = #{stuId}  
		        AND lect_no = #{lectNo}
		
		
		
	</select>
	


</mapper>
