<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn"%>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="${pageContext.request.contextPath }/resources/js/ckeditor5/ckeditor5.css">
<script type="importmap">
{
	"imports": {
					"ckeditor5": "${pageContext.request.contextPath }resources/js/ckeditor5/ckeditor5.js",
					"ckeditor5/": "${pageContext.request.contextPath }/resources/js/ckeditor5/translations/ko.js/"
	}
}
</script>

<style>

.card {
    border: 1px solid #000;
}
.card-header {
    background-color: #f8f9fa;
    font-weight: bold;
}
.card-footer {
    background-color: #f8f9fa;
}

</style>
<input type="hidden" id="form-table" data-auth="${pageContext.request.userPrincipal.name }" data-path="${pageContext.request.contextPath }" value="${lecture.lectNo }">

  <div class="container mt-4">
    <h1 class="text-center mb-4">과제 제출 관리</h1>
    
    <!-- 과제 리스트 -->
    <div class="accordion" id="assignmentAccordion">
        <c:forEach var="assignment" items="${assignmentList}" varStatus="status">
            <div class="accordion-item">
                <!-- 과제 제목 -->
                <div class="accordion-header d-flex justify-content-between align-items-center" id="heading-${assignment.assigNo}">
                    <span class="fw-bold text-primary" role="button" data-bs-toggle="modal" 
                          data-bs-target="#assignmentModal-${assignment.assigNo}">
                        과제명: ${assignment.assigNm}
                    </span>
                    <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" 
                            data-bs-target="#collapse-${assignment.assigNo}" 
                            aria-expanded="false" aria-controls="collapse-${assignment.assigNo}">
                        제출 과제 보기
                    </button>
                </div>

                <!-- 제출 과제 리스트 -->
                <div id="collapse-${assignment.assigNo}" class="accordion-collapse collapse" 
                     aria-labelledby="heading-${assignment.assigNo}" data-bs-parent="#assignmentAccordion">
                    <div class="accordion-body">
                        <h5 class="mt-3">제출된 과제</h5>
                        <div class="list-group">
                            <c:forEach var="submission" items="${assignment.assignmentsubmissionList}">
                            <hr style="border: 2px solid blue;"/>
                                <div class="list-group-item">
                                	<table class="table table-bordered">
                                		<tr class="text-center">
                                			<th>학번</th>
                                			<td colspan="2">${submission.stuId}</td>
                                		</tr>
                                		<tr class="text-center">
                                			<th>제출일 | 제출마감일</th>
                                			<td>${fn:substring(submission.assubDate, 0, 4)}-${fn:substring(submission.assubDate, 4, 6)}-${fn:substring(submission.assubDate, 6, 8)}</td>
                                			<td>${fn:substring(assignment.assigEd, 0, 4)}-${fn:substring(assignment.assigEd, 4, 6)}-${fn:substring(assignment.assigEd, 6, 8)}</td>
                                		</tr>
                                		<tr class="text-center">
                                			<th>과제점수 | 배점</th>
                                			<td>${submission.assubScore }</td>
                                			<td>${assignment.assigScore }</td>
                                		</tr>
                                		<tr class="text-center">
                                			<th>첨부파일</th>
                                			<td colspan="2">
					                            <c:forEach items="${submission.atchFile.fileDetails }" var="sufd" varStatus="suvs">
												<c:url value='/atch/${sufd.atchFileId }/${sufd.fileSn }' var="downUrl"/>
												<a href="${downUrl }">${sufd.orignlFileNm }(${sufd.fileFancysize })</a>
													${not suvs.last ? '|' : ''}
												</c:forEach>
												<c:if test="${empty submission.atchFile.fileDetails}">
												    첨부파일없음
												</c:if>
											</td>
                                		</tr>
                                		<tr>
				                            <th class="text-center">내용</th>
				                            <td colspan="2">${submission.assubNotes}</td>
				                        </tr>
				                        <c:if test="${pageContext.request.userPrincipal.name eq submission.stuId }">
				                        <tr class="text-center">
				                        	<td colspan="3">
				                        	<c:if test="${submission.assubYn eq 'N' }">
				                        		<button id="submitBtn" class="btn btn-primary"
				                        		
				                        		
				                        		
				                        		>제출</button>
				                        	</c:if>
				                        	<c:if test="${submission.assubYn eq 'Y' }">
				                        		<button id="modifyBtn" class="btn btn-info">수정</button>
				                        		<button id="delBtn" class="btn btn-danger">삭제</button>
				                        	</c:if>
				                        	</td>
				                        </tr>
				                        </c:if>
				                        <c:if test="${fn:substring(pageContext.request.userPrincipal.name, 4, 6) eq '30' }">
				                        <tr class="text-center">
				                        	<td colspan="3">
				                        	<c:if test="${empty submission.assubScore and submission.assubYn eq 'Y' and  submission.peerYn eq 'Y'}">
				                        		<button id="gradeBtn" class="btn btn-primary">채점</button>
				                        	</c:if>
				                        	</td>
				                        </tr>
				                        </c:if>
                                	</table>
                                </div>
                                <hr style="border: 2px solid blue;"/>
                            </c:forEach>
                        </div>
                    </div>
                </div>
            </div>
            
			<!-- 수정 / 제출 모달 창  -->
			<div class="modal fade" id="formModal" tabindex="-1" 
                 aria-labelledby="formModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="formModalLabel">
                                과제명: ${assignment.assigNm}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                        	<form id="modalForm" enctype="multipart/form-data">
                        	<table class="table table-bordered">
                        		<tr>
		                            <th>제출마감일</th>
		                            <td>
		                            <input type="hidden" value="${assignment.assigEd }">
		                            ${fn:substring(assignment.assigEd, 0, 4)}-${fn:substring(assignment.assigEd, 4, 6)}-${fn:substring(assignment.assigEd, 6, 8)}
		                            </td>
		                        </tr>
		                        
                        		<tr>
									<th>기존파일</th>
									<td>
										<c:forEach items="${submission.atchFile.fileDetails }" var="formfd" varStatus="formvs">
											<span>
												${formfd.orignlFileNm }[${formfd.fileFancysize }]
												<a data-atch-file-id="${formfd.atchFileId }" data-file-sn="${formfd.fileSn }" class="btn btn-danger" href="javascript:;">
													삭제						
												</a>
													${not formvs.last ? '|' : ''}
												</span>
										</c:forEach>		
										<c:if test="${empty submission.atchFile.fileDetails}">
										    기존첨부파일없음
										</c:if>
									</td>
								</tr>
								<tr>
									<th>첨부파일</th>
									<td>
										<input type="file" name="uploadFiles" multiple class="form-control"/>	
									</td>
								</tr>
                        		
		                        <tr>
									<th>내용</th>
									<td>
									<textarea id="editor">${submission.assubNotes }</textarea>
									</td>
								</tr>
								
                        	</table>
                        	</form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        </div>
                    </div>
                </div>
            </div>
			
			
			
			
            <!-- 과제상세보기 모달 창 -->
            <div class="modal fade" id="assignmentModal-${assignment.assigNo}" tabindex="-1" 
                 aria-labelledby="assignmentModalLabel-${assignment.assigNo}" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="assignmentModalLabel-${assignment.assigNo}">
                                번호: ${assignment.rnum }		| 	과제명: ${assignment.assigNm}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                        	<table class="table table-bordered">
                        		<tr>
		                            <th>배점</th>
		                            <td>${assignment.assigScore != null ? assignment.assigScore : '설정되지않음'}</td>
		                        </tr>
                        		<tr>
		                            <th>제출마감일</th>
		                            <td>${fn:substring(assignment.assigEd, 0, 4)}-${fn:substring(assignment.assigEd, 4, 6)}-${fn:substring(assignment.assigEd, 6, 8)}</td>
		                        </tr>
                        		<tr>
		                            <th>피어리뷰여부</th>
		                            <td>${assignment.peerYn}</td>
		                        </tr>
		                        <tr>
		                            <th>첨부파일</th>
		                            <td>
			                            <c:forEach items="${assignment.atchFile.fileDetails }" var="fd" varStatus="vs">
										<c:url value='/atch/${fd.atchFileId }/${fd.fileSn }' var="downUrl"/>
										<a href="${downUrl }">${fd.orignlFileNm }(${fd.fileFancysize })</a>
											${not vs.last ? '|' : ''}
										</c:forEach>
										<c:if test="${empty assignment.atchFile.fileDetails}">
										    첨부파일없음
										</c:if>
									</td>
		                        </tr>
		                        <tr>
									<th>내용</th>
									<td>${assignment.assigNotes }</td>
								</tr>
                        	</table>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        </div>
                    </div>
                </div>
            </div>
        </c:forEach>
    </div>
</div>

<script src="${pageContext.request.contextPath }/resources/js/useckeditor5/editor.js" type="module"></script>
<script src="${pageContext.request.contextPath }/resources/js/assignmentSubmission/assignmentSubmission.js"></script>