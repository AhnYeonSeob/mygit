/**
 *  체크박스 선택 후 수정버튼 누르면 해당 과제 수정형식으로 변경
 *	저장버튼 클릭시 해당 과제 수정처리
 */
import {
		ClassicEditor,
		SimpleUploadAdapter,
		Bold,
		Italic,
		Underline,
		BlockQuote,
		Essentials,
		Heading,
		Image,
		ImageUpload,
		Link,
		List,
		MediaEmbed,
		Table,
		TableToolbar,
		FontSize,
		FontFamily,
		FontColor,
		Undo
	
	} from '../../../resources/js/ckeditor5/ckeditor5.js';

document.addEventListener("DOMContentLoaded", () => {
	const contextPath = document.getElementById("projectControl").dataset.path;
	const lectNo = document.getElementById("projectControl").dataset.lectno;
    const editTaskBtn = document.getElementById("editTaskBtn");
	const selectAllCheckbox = document.getElementById("selectAll");
    const taskCheckboxes = document.querySelectorAll(".task-select");
	const deleteTaskBtn = document.getElementById("deleteTaskBtn");

	var editors = {};
	
	deleteTaskBtn.addEventListener("click",()=>{
		const selectedTasks = document.querySelectorAll(".task-select:checked");

	    if (selectedTasks.length == 0) {
	        swal("알림", "삭제할 프로젝트를 선택하세요.", "warning");
	        return;
	    }
		
		swal({
	        title: "삭제하시겠습니까?",
	        text: "한번 삭제한 프로젝트는 복구가 불가능할 수 있습니다.",
	        icon: "warning",
	        buttons: ["취소", "삭제"],
	        dangerMode: true,
	    }).then((willCancel) => {
	        if (willCancel) {
	           // 삭제 처리
            const deletePromises = Array.from(selectedTasks).map((checkbox) => {
                const taskNo = checkbox.value;
                return fetch(`${contextPath}/lecture/${lectNo}/projectTask/${taskNo}`, {
                    method: "DELETE",
                    headers: {
                        "Accept": "application/json",
                    },
                });
            });

            Promise.all(deletePromises)
                .then((responses) => {
                    const allSuccessful = responses.every((res) => res.ok);

                    if (allSuccessful) {
                        swal("삭제되었습니다!", {
                            icon: "success",
                        }).then(() => {
                            window.location.reload(); // 페이지 새로고침
                        });
                    } else {
                        swal("실패", "일부 프로젝트 삭제 중 문제가 발생했습니다.", "error");
                    }
                })
                .catch((err) => {
                    console.error("통신 오류:", err);
                    swal("실패", "서버와의 통신에 문제가 발생했습니다.", "error");
                });
	        }
	    });
	});//삭제버튼 눌렀을 때 이벤트 끝
	
	
	
	// 기존파일 삭제처리
	document.querySelectorAll("[data-atch-file-id][data-file-sn]").forEach(el=>{
    	el.addEventListener("click", async (e)=>{
    		e.preventDefault();
    		let atchFileId = el.dataset.atchFileId;
    		let fileSn = el.dataset.fileSn;
			let resp = await fetch(`${contextPath}/atch/${atchFileId}/${fileSn}`, {
    			method:"delete"
    			, headers:{
    				"accept":"application/json"
    			}
    		});
    		if(resp.ok){
    			let obj = await resp.json();
    			if(obj.success){
					el.parentElement.remove();    				
    			}
    		}
    	});
    });
	//모달창 상세보기 이벤트
	 document.body.addEventListener("click", async (e) => {
        if (e.target && e.target.classList.contains("view-task-details")) {
            const taskNo = e.target.dataset.taskId;
            
            try {
                const response = await fetch(`${contextPath}/lecture/${lectNo}/projectTask/${taskNo}`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "Accept": "application/json",
                    },
                });

                if (!response.ok) {
                    swal("실패", "과제 정보를 가져오는 데 실패했습니다.", "error");
                    return;
                }

                const taskData = await response.json();
                
                // 모달 내용 업데이트
                const taskDetailsContent = document.getElementById("taskDetailsContent");
                taskDetailsContent.innerHTML = `
                    <ul class="list-group">
                        <li class="list-group-item"><strong>주제:</strong> ${taskData.taskTitle}</li>
                        <li class="list-group-item"><strong>제출 마감일:</strong> ${taskData.taskEt.slice(0, 4)}-${taskData.taskEt.slice(4, 6)}-${taskData.taskEt.slice(6, 8)}</li>
                        <li class="list-group-item"><strong>배점:</strong> ${taskData.taskScore}점</li>
                        
                        <li class="list-group-item"><strong>첨부 파일:</strong> ${
                            taskData.atchFile && taskData.atchFile.fileDetails.length
                                ? taskData.atchFile.fileDetails.map((fd) => `
                                    <a href="${contextPath}/atch/${fd.atchFileId}/${fd.fileSn}" target="_blank">
                                        ${fd.orignlFileNm} (${fd.fileFancysize})
                                    </a>
                                `).join(", ")
                                : "없음"
                        }</li>
						<li class="list-group-item"><strong>내용:</strong> ${taskData.taskNotes}</li>
                    </ul>
                `;

                // 모달 표시
                const modal = new bootstrap.Modal(document.getElementById("taskDetailsModal"));
                modal.show();
            } catch (err) {
                console.error(err);
                swal("실패", "서버와의 통신에 문제가 발생했습니다.", "error");
            }
        }
    });
	
	
	
	
	// 전체 선택 / 해제 이벤트
    selectAllCheckbox.addEventListener("change", () => {
        const isChecked = selectAllCheckbox.checked;
        taskCheckboxes.forEach((checkbox) => {
            checkbox.checked = isChecked;
        });
    });

    // 개별 체크박스 상태 변경 시 전체 선택 체크박스 상태 갱신
    taskCheckboxes.forEach((checkbox) => {
        checkbox.addEventListener("change", () => {
            const allChecked = Array.from(taskCheckboxes).every((box) => box.checked);
            const noneChecked = Array.from(taskCheckboxes).every((box) => !box.checked);

            if (allChecked) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false; // 중간 상태 해제
            } else if (noneChecked) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false; // 중간 상태 해제
            } else {
                selectAllCheckbox.indeterminate = true; // 중간 상태
            }
        });
    });
	
     // 수정 버튼 클릭 이벤트
    editTaskBtn.addEventListener("click", () => {
        const selectedTasks = document.querySelectorAll(".task-select:checked");

        if (selectedTasks.length === 0) {
            swal("알림", "수정할 과제를 선택하세요.", "warning");
            return;
        }

        selectedTasks.forEach(async (checkbox) => {
            const taskRow = document.getElementById(`task-row-${checkbox.value}`);
            const existingFormRow = document.getElementById(`edit-row-${checkbox.value}`);
            if (existingFormRow) return;

            try {
                const response = await fetch(`${contextPath}/lecture/${lectNo}/projectTask/${checkbox.value}`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "Accept": "application/json",
                    },
                });

                if (!response.ok) {
                    swal("실패", "과제 정보를 가져오는 데 실패했습니다.", "error");
                    return;
                }

                const taskData = await response.json();
                const taskEtFormatted = `${taskData.taskEt.slice(0, 4)}-${taskData.taskEt.slice(4, 6)}-${taskData.taskEt.slice(6, 8)}`;

                const fileDetailsHTML = taskData.atchFile?.fileDetails?.length
                    ? taskData.atchFile.fileDetails.map((fd) => `
                        <span>
                            ${fd.orignlFileNm} [${fd.fileFancysize}]
                            <a 
                                data-atch-file-id="${fd.atchFileId}" 
                                data-file-sn="${fd.fileSn}" 
                                class="btn btn-danger btn-sm file-delete-btn" 
                                href="javascript:;">
                                삭제
                            </a>
                        </span>
                    `).join("")
                    : "파일없음";

                const editFormHTML = `
                    <div class="edit-form-wrapper p-3 border rounded">
                        <form id="editForm-${checkbox.value}">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label>과제 주제</label>
                                    <input type="text" class="form-control" name="taskTitle" value="${taskData.taskTitle}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label>과제 제출 마감일</label>
                                    <input type="date" class="form-control" name="taskEt" value="${taskEtFormatted}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label>배점</label>
                                    <input type="number" class="form-control" name="taskScore" value="${taskData.taskScore}">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label>기존 첨부 파일</label>
								<input type="hidden" name="atchFileId" value="${taskData.atchFileId}">
                                <div class="existing-files mb-2">${fileDetailsHTML}</div>
                                <input type="file" class="form-control mt-2" name="uploadFiles" multiple>
                            </div>
                            <div class="mb-3">
                                <label>과제 내용</label>
                                <textarea id="editor-${checkbox.value}" class="form-control">${taskData.taskNotes}</textarea>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-primary save-task-btn" data-task-id="${checkbox.value}">저장</button>
                                <button type="button" class="btn btn-secondary cancel-task-btn" data-task-id="${checkbox.value}">취소</button>
                            </div>
                        </form>
                    </div>
                `;

                const newRow = document.createElement("tr");
                newRow.id = `edit-row-${checkbox.value}`;
                newRow.innerHTML = `<td colspan="5">${editFormHTML}</td>`;
                taskRow.after(newRow);
				
				//이미지 업로드 처리할때 보안때문에 html에서 제공하는 token 사용
				const csrfMetaTag = document.querySelector('meta[name="csrf-token"]');
				//만약 meta 설정이 없는 경우 null로 초기화 있다면, token값 가져옴
				const csrfToken = csrfMetaTag ? csrfMetaTag.getAttribute('content') : null;
				
				//Editor의 종류중 사용할 Editor 생성 ClassicEditor권장 다른 종류 사용하고싶다면, 문서확인 후 사용
				ClassicEditor.create( document.querySelector(`#editor-${checkbox.value}`),{
					licenseKey: 'GPL' //5버전 기본 라이센스키 ; 필수값
					//사용할 플러그인 플러그인종류는 문서확인
					,  plugins: [
			            Essentials, Bold, Italic, Underline, Link, Image, ImageUpload,
			            List, BlockQuote, Heading, MediaEmbed, Table, TableToolbar, 
			            FontSize, FontFamily, FontColor, Undo, SimpleUploadAdapter
			        ],
					// 툴바 메뉴
			        toolbar: [
			            'undo', 'redo', '|', 'bold', 'italic', 'underline', '|', 'link', 'imageUpload', '|',
			            'bulletedList', 'numberedList', '|', 'blockquote', 'insertTable', '|',
			            'fontSize', 'fontFamily', 'fontColor', '|', 'mediaEmbed'
			        ]
					,language: 'ko' // 한국어 설정
					//이미지 업로드 어댑터 config설정
					//이미지 url은 noticeboard폴더에 해당 처리 controller를 만들어두었음.
					//컨트롤러에서 반환값은 url임으로 반환값이 어떻게 오는지 알아야 데이터를 처리할 수 있음.
					, simpleUpload: { 
								uploadUrl: `${contextPath}/imageUpload`
								, headers:  csrfToken ? { 'X-CSRF-TOKEN': csrfToken } : {}
								
						}
				})
				//promise객체가 반환됨.
				 .then(editor => {
			        editors[checkbox.value] = editor;
			    })
			    .catch(error => {
			        console.error(error);
			
				})//create에디터 끝

                // 취소 버튼 이벤트
				document.querySelector(`.cancel-task-btn[data-task-id="${checkbox.value}"]`).addEventListener("click", () => {
				   
	
					 // CKEditor 인스턴스 제거
				    if (editors[checkbox.value]) {
				        editors[checkbox.value].destroy().then(() => {
				            delete editors[checkbox.value]; // editors 객체에서 제거
				        }).catch(err => console.error("CKEditor 제거 중 오류:", err));
				    }
				
				    // 수정 행 삭제
				    const editRow = document.getElementById(`edit-row-${checkbox.value}`);
				    if (editRow) {
				        editRow.remove(); // 수정 폼 행 삭제
				    }
				});

                // 저장 버튼 이벤트
                document.querySelector(`.save-task-btn[data-task-id="${checkbox.value}"]`).addEventListener("click", async () => {
                    const editForm = document.getElementById(`editForm-${checkbox.value}`);
                    const formData = new FormData(editForm);
					const taskNotes = editors[checkbox.value].getData();
					
                    formData.append("taskNotes", taskNotes);
                    formData.append("taskNo", checkbox.value);

					for (let [key, value] of formData.entries()) {
					    console.log(key, value);
					}

                    try {
                        const response = await fetch(`${contextPath}/lecture/${lectNo}/projectTask/edit/${checkbox.value}`, {
                            method: "POST",
                            body: formData,
                        });

                        if (response.ok) {
                            swal("성공", "과제가 성공적으로 수정되었습니다!", "success").then(() => {
                                window.location.reload();
                            });
                        } else {
                            const error = await response.json();
                            swal("실패", error.message || "과제 수정 중 문제가 발생했습니다.", "error");
                        }
                    } catch (err) {
                        console.error(err);
                        swal("실패", "서버와의 통신에 문제가 발생했습니다.", "error");
                    }
                });
            } catch (err) {
                console.error(err);
                swal("실패", "서버와의 통신에 문제가 발생했습니다.", "error");
            }
        });
    });
});